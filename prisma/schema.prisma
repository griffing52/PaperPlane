// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema
// Prisma Schema for Aviation Logbook System

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// Enums
enum UploadStatus {
  PENDING
  PROCESSING
  DONE
  FAILED
}

enum JobStatus {
  QUEUED
  RUNNING
  DONE
  ERRORED
  FAILED
}

enum FlightSource {
  OCR
  MANUAL
}

enum VerificationStatus {
  VERIFIED
  PARTIAL
  UNVERIFIED
}


// Models
model User {
  id        String   @id @default(uuid())
  email     String   @unique
  name      String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  pilot Pilot?

  @@map("users")
}

model Pilot {
  userId        String   @id
  licenseNumber String   @unique
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  logbookUploads LogbookUpload[]
  flights        FlightEntry[]

  @@map("pilots")
}

model LogbookUpload {
  id             String       @id @default(uuid())
  pilotId        String
  filePath       String       // or storage URL
  status         UploadStatus @default(PENDING)
  time DateTime?
  errorMessage   String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  
  pilot   Pilot     @relation(fields: [pilotId], references: [userId], onDelete: Cascade)

  // TODO: What are the units?
  // ocrConfidence  Float?
  source         FlightSource
  flights        FlightEntry[]
}

model Flight {
  id                      String        @id @default(uuid())
  tailNumber              String        @map("tail_number")
  aircraftModel           String        @map("aircraft_model")
  manufacturer            String
  originAirportIcao       String        @map("origin_airport_icao")
  destinationAirportIcao  String        @map("destination_airport_icao")
  departureTime           DateTime      @map("departure_time")
  arrivalTime             DateTime      @map("arrival_time")
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt
  
  // Relations
  flightEntries           FlightEntry[]
  
  @@map("flights")
}

model FlightEntry {
  id                 String       @id @default(uuid())
  flightId           String       @map("flight_id")
  pilotId            String       @map("pilot_id")
  uploadId           String?      @map("upload_id")

  // Flight time categories - required for certificates/ratings
  totalFlightTime           Decimal  @default(0)  // Total duration of this flight
  picTime                   Decimal  @default(0)  // Pilot in Command
  sicTime                   Decimal  @default(0)  // Second in Command
  soloTime                  Decimal  @default(0)  // Solo (student pilot)
  dualReceivedTime          Decimal  @default(0)  // Training with instructor
  dualGivenTime             Decimal  @default(0)  // Time instructing (CFI)

  // Special conditions - required for ratings
  crossCountryTime          Decimal  @default(0)  // XC (>50nm + landing elsewhere)
  nightTime                 Decimal  @default(0)  // Night (civil twilight to twilight)
  actualInstrumentTime      Decimal  @default(0)  // Actual IMC
  simulatedInstrumentTime   Decimal  @default(0)  // Hood/foggles

  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt

  flight             Flight       @relation(fields: [flightId], references: [id], onDelete: Cascade)
  pilot              Pilot        @relation(fields: [pilotId], references: [userId], onDelete: Cascade)
  upload             LogbookUpload? @relation(fields: [uploadId], references: [id])

  @@map("flight_entries")
}

// model VerificationResult {
//   id               String             @id @default(uuid())
//   entryId          String             @unique
//   status           VerificationStatus
//   score            Float
//   reasonForFail    String?
//   matchedHours     Decimal?
//   notes            String?
//   createdAt        DateTime           @default(now())
//   updatedAt        DateTime           @updatedAt
  
//   entry FlightEntry @relation(fields: [entryId], references: [id], onDelete: Cascade)

//   @@map("verification_results")
// }
